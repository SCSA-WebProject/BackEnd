<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.mvc.model.dao.BoardDao">
	<!-- mybatis.configuration.map-underscore-to-camel-case=true 설정이 있어서 아래 
		map 필요 업음 -->


	<resultMap id="boardMap" type="Board">
		<id column="id" property="id"/>
		<result column="title" property="title"/>
		<result column="region" property="region"/>
		<result column="category" property="category"/>
		<result column="price" property="price"/>
		<result column="user_id" property="userId"/>
	</resultMap>
	<!-- 전체 맛집 목록 조회 -->
	<select id="selectAll" resultMap="boardMap">
		SELECT id, title, region, category, price, user_id
		FROM BOARD
		ORDER BY ID DESC
		LIMIT #{offset}, #{listSize}
	</select>

	<!-- 맛집 카운트 -->
	<select id="selectBoardCount" resultType="int" parameterType="BoardSearch">
		SELECT COUNT(*) FROM BOARD
	</select>

	<!-- 상세 맛집 조회 -->
	<select id="selectOne" resultMap="boardMap" parameterType="int">
		SELECT id, title, region, category, price, user_id
		FROM BOARD
		WHERE id = #{id}
	</select>

	<!-- 맛집 등록 -->
	<insert id="insertBoard" parameterType="Board" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO BOARD (title, region, category, price, user_id)
		VALUES (#{title}, #{region}, #{category}, #{price}, #{userId})
	</insert>

	<!-- 맛집 삭제 -->
	<delete id="deleteBoard" parameterType="int">
		DELETE FROM BOARD
		WHERE id = #{id}
	</delete>

	<!-- 맛집 수정 -->
	<update id="updateBoard" parameterType="Board">
		UPDATE BOARD
		SET title = #{title},
			region = #{region},
			category = #{category},
			price = #{price}
		WHERE id = #{id} AND user_id = #{userId}
	</update>

	<!-- 검색기능 -->
	<select id="selectByWhere" resultMap="boardMap" parameterType="SearchCondition">
		SELECT id, title, region, category, price, user_id
		FROM BOARD
		<where>
			<choose>
				<when test="key == 'titleNregion'">
					(title LIKE CONCAT('%', #{word}, '%') OR region LIKE CONCAT('%', #{word}, '%'))
				</when>
				<when test="key == 'category'">
					category = #{word}
				</when>
				<when test="key == 'price'">
					price &lt;= #{word}
				</when>
				<otherwise>
					${key} LIKE CONCAT('%', #{word}, '%')
				</otherwise>
			</choose>
		</where>
		<if test="orderBy != 'none'">
			ORDER BY ${orderBy} ${orderByDir}
		</if>
	</select>

	<select id="selectBoardFileByNo" resultType="BoardFile" parameterType="int">
		SELECT file_id, id, file_path, ori_name, system_name
		FROM BOARD_FILE
		WHERE id = #{id}
		ORDER BY file_id DESC
		LIMIT 1
	</select>

	<insert id="insertBoardFile" parameterType="BoardFile">
		INSERT INTO BOARD_FILE (file_path, ori_name, system_name, id)
		VALUES (#{filePath}, #{oriName}, #{systemName}, #{id})
	</insert>

	<!-- 좋아요 토글 -->
	<insert id="toggleLike" parameterType="map">
		INSERT INTO Users_Board_likes (board_id, user_id, liked)
		VALUES (#{boardId}, #{userId}, true)
		ON DUPLICATE KEY UPDATE liked = NOT liked
	</insert>

	<!-- 좋아요 상태 확인 -->
	<select id="checkLike" resultType="boolean" parameterType="map">
		SELECT COALESCE(liked, false)
		FROM Users_Board_likes
		WHERE board_id = #{boardId} AND user_id = #{userId}
	</select>

	<!-- 좋아요 수 조회 -->
	<select id="getLikeCount" resultType="int" parameterType="int">
		SELECT COUNT(*)
		FROM Users_Board_likes
		WHERE board_id = #{boardId} AND liked = true
	</select>
</mapper>